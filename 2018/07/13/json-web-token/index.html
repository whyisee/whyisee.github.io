<!DOCTYPE html><html lang="zh"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><meta name="description" content="Zoukh&#39;s blog"><meta name="keyword" content="blog,front end,css,html,javascript"><link rel="shortcut icon" href="/css/images/logo.png"><title>[译] JSON Web Token Intro | Zoukh&#39;s Blog</title><link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><link href="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.css" rel="stylesheet"><link href="//cdn.bootcss.com/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/style.css"><script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><script src="//cdn.bootcss.com/geopattern/1.2.3/js/geopattern.min.js"></script><script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });</script><script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script></head><div class="wechat-share"><img src="/css/images/logo.png" alt="logo"></div><body><div id="container"><header class="header fixed-header"><div class="header-container"><a class="home-link" href="/"><div class="logo"></div><span><svg height="60" width="250" id="header-svg"><symbol id="s-text"><text text-anchor="left" x="0%" y="50%" dy=".35em">Zoukh's Blog</text></symbol><use class="text" xlink:href="#s-text"></use><use class="text" xlink:href="#s-text"></use><use class="text" xlink:href="#s-text"></use><use class="text" xlink:href="#s-text"></use><use class="text" xlink:href="#s-text"></use></svg><style>#header-svg{position:absolute;top:0}@media screen and (max-width:768px){#header-svg{top:-7px}}.text{fill:none;stroke-width:2;stroke-linejoin:round;stroke-dasharray:40 185;stroke-dashoffset:0;-webkit-animation:stroke 8s infinite linear;animation:stroke 8s infinite linear;font-size:40px;line-height:1;height:40px}.text:nth-child(5n+1){stroke:#f2385a;-webkit-animation-delay:-1.6s;animation-delay:-1.6s}.text:nth-child(5n+2){stroke:#f5a503;-webkit-animation-delay:-3.2s;animation-delay:-3.2s}.text:nth-child(5n+3){stroke:#42b983;-webkit-animation-delay:-4.8s;animation-delay:-4.8s}.text:nth-child(5n+4){stroke:#56d9cd;-webkit-animation-delay:-6.4s;animation-delay:-6.4s}.text:nth-child(5n+5){stroke:#3aa1bf;-webkit-animation-delay:-8s;animation-delay:-8s}@-webkit-keyframes stroke{100%{stroke-dashoffset:-225}}@keyframes stroke{100%{stroke-dashoffset:-225}}</style></span></a><ul class="right-list"><li class="list-item"><a href="/" class="item-link">Home</a></li><li class="list-item"><a href="/tags/" class="item-link">Tags</a></li><li class="list-item"><a href="/archives/" class="item-link">Archives</a></li><li class="list-item"><a href="/project/" class="item-link">Project</a></li><li class="list-item"><a href="/about/" class="item-link">About</a></li></ul><div class="menu"><span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></div><div class="menu-mask"><ul class="menu-list"><li class="menu-item"><a href="/" class="menu-link">Home</a></li><li class="menu-item"><a href="/tags/" class="menu-link">Tags</a></li><li class="menu-item"><a href="/archives/" class="menu-link">Archives</a></li><li class="menu-item"><a href="/project/" class="menu-link">Project</a></li><li class="menu-item"><a href="/about/" class="menu-link">About</a></li></ul></div></div></header><div id="article-banner"><h2>[译] JSON Web Token Intro</h2><p class="post-date">2018-07-13</p></div><main class="app-body flex-box"><article class="post-article"><section class="markdown-content"><h2 id="什么是-JSON-Web-Token"><a href="#什么是-JSON-Web-Token" class="headerlink" title="什么是 JSON Web Token?"></a>什么是 JSON Web Token?</h2><p>JSON Web Token(JWT)定义了一个紧凑独立的开放标准（<a href="https://tools.ietf.org/html/rfc7519" target="_blank" rel="noopener">RFC 7519</a>）,通过一个 JSON 对象来安全的传输数据。这些数据是可信的因为它们经过数字签名的。JWTs 可以使用一个密钥（使用 HMAC 算法）或 RSA 的公/私匙对来进行签名。</p><p>虽然 JWTs 可以被加密为通信提供隐秘性，但是我们只关注于签名令牌（signed tokens）。签名令牌可以验证声明内容的完整性，但是加密 JWTs 会隐藏声明内容。当 JWTs 使用公/私钥对加密后，那么只有拥有私钥的一方能够验证其有效性。</p><p>让我们来进一步阐述一些概念。</p><ul><li><p>紧凑性，为了更小的体积，JWTs 可以通过 URL,HTTP POST 参数或 HTTP Header 进行传输。另外，更小的体积意味着更快的传输速度。</p></li><li><p>独立性，JWTs 的载荷中包含了关于用户的全部信息，避免多次查询数据库。</p></li></ul><h2 id="什么情况下我们应该使用-JSON-Web-Tokens？"><a href="#什么情况下我们应该使用-JSON-Web-Tokens？" class="headerlink" title="什么情况下我们应该使用 JSON Web Tokens？"></a>什么情况下我们应该使用 JSON Web Tokens？</h2><p>这里有一些 JSON Web Tokens 的适用场景：</p><ul><li><p>认证：这是使用 JWT 最常见的场景。一但用户登录后，之后用户的请求将都包含 JWT，用户可以访问令牌权限范围内的路由，服务，资源。单点登录是 JWT 现在被使用最多的一个特性，因为它开支小，可以在多个不同的域名中使用。</p></li><li><p>信息交换：JOSN Web Tokens 是进行安全通信的不错的方法。因为它是可以被签名认证 —— 例如公私钥对，你可以确定发送者的身份。另外，签名是通过其 header 和载荷计算生成的，可以验证内容以确保内容不被篡改。</p></li></ul><h2 id="JSON-Web-Tokens-的结构是什么样的？"><a href="#JSON-Web-Tokens-的结构是什么样的？" class="headerlink" title="JSON Web Tokens 的结构是什么样的？"></a>JSON Web Tokens 的结构是什么样的？</h2><p>在它紧凑的格式中，JSON Web Tokens 由三部分组成使用（<code>.</code>）隔开：</p><ul><li>Header,头部</li><li>Payload,载荷</li><li>Signature,签名</li></ul><p>因此一个典型的 JWT 格式如下。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxxxx.yyyyy.zzzzz</span><br></pre></td></tr></table></figure><p>然我们来分解成不同部分介绍。</p><h3 id="头部（Header）"><a href="#头部（Header）" class="headerlink" title="头部（Header）"></a>头部（Header）</h3><p>头部通常包含两部分，令牌（token）类型值为 JWT,使用的 hash 算法（例如，HMAC SHA256 or RSA）。</p><p>例子：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"alg"</span>: <span class="string">"HS256"</span>,</span><br><span class="line">  <span class="attr">"typ"</span>: <span class="string">"JWT"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后，首部通过 Base64Url 转码为 JWT 的第一部分。</p><h3 id="载荷（Payload）"><a href="#载荷（Payload）" class="headerlink" title="载荷（Payload）"></a>载荷（Payload）</h3><p>令牌（token）的第二部分是载荷，包含了声明。声明包含了实体（通常是用户）和一些附加的元数据。声明包含三种类型： 内置（registered）,公有（public）,私有（private）。</p><ul><li>内置声明：其包含一系列预定义声明，不强制但是推荐使用来提供有用的，可协作性的的声明。部分如下：<br><strong>iss</strong>(issuer),<strong>exp</strong>(expiration time),<strong>sub</strong>(subject),<strong>aud</strong><br>(audience)和<a href="https://tools.ietf.org/html/rfc7519#section-4.1" target="_blank" rel="noopener">其他声明</a>。</li></ul><blockquote><p>注意这些声明为了和 JWT 的紧凑理念相一致，因此声明名都是三个字符。</p></blockquote><ul><li><p>公有声明： 这部分可以由 JWTs 的使用者定义，但是注意避免冲突，应当在<a href="https://www.iana.org/assignments/jwt/jwt.xhtml" target="_blank" rel="noopener">IANA JSON Web Token Registry</a>中有定义，或者定义为包含命名空间（避免冲突）的 URI。</p></li><li><p>私有声明： 这部分定义的声明的是双方验证同意共享信息而创建的声明，不包含在内置或共有声明中。</p></li></ul><p>例如一个载荷可以如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"sub"</span>: <span class="string">"1234567890"</span>,</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"John Doe"</span>,</span><br><span class="line">  <span class="attr">"admin"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>载荷被 Base64Url 转码作为 JSON Web Tokens 的第二部分。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注意对于签名令牌，虽然他们被保护防止被篡改，但是对任何人都是可读的。不要将密钥放置在载荷头部中除非签名令牌是加密的。</span><br></pre></td></tr></table></figure><h2 id="签名-Signature"><a href="#签名-Signature" class="headerlink" title="签名(Signature)"></a>签名(Signature)</h2><p>为了创建签名我们需要转码的头部，转码的载荷，一个密钥(secret)。通过头部声明的加密算法生成签名。</p><p>例如如果你想使用 HMAC SHA256 算法，签名可以通过如下方法生成：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HMACSHA256(base64UrlEncode(header) + <span class="string">"."</span> + base64UrlEncode(payload), secret);</span><br></pre></td></tr></table></figure><p>这个签名可以用于校验传输内容不被修改，而且由于令牌通过一个私有密钥签名，我们可以验证发起请求的用户和 JWT 中用户是否一致。</p><h2 id="放在一起"><a href="#放在一起" class="headerlink" title="放在一起"></a>放在一起</h2><p>最终得到的是 3 个以（<code>.</code>）隔开的 Base64-URL 字符串，可以轻松通过 HTML,HTTP 运行环境，相比 XML-based 标准如 SAML 更加紧凑。</p><p>下面是一个头部载荷转码，使用加密签名的的 JWT。</p><p><img src="https://cdn.auth0.com/content/jwt/encoded-jwt3.png" alt=""></p><p>如果你想玩玩 JWT，练习其中的各种概念，你可以使用<a href="http://jwt.io/" target="_blank" rel="noopener">jwt.io Debugger</a>来转码，验证，生成 JWTs。</p><p><img src="https://cdn.auth0.com/blog/legacy-app-auth/legacy-app-auth-5.png" alt=""></p><h2 id="JSON-Web-Tokens-是如何工作的？"><a href="#JSON-Web-Tokens-是如何工作的？" class="headerlink" title="JSON Web Tokens 是如何工作的？"></a>JSON Web Tokens 是如何工作的？</h2><p>在身份验证中，当用户身份验证成功后，将返回一个 JSON Web Token 并且需要保存在本地（如本地存储，cookie）,代替传统的创建一个绘画并返回一个 cookie。</p><blockquote><p>出于安全性考虑需要注意令牌的存储方式，它们枚举在<a href="https://auth0.com/docs/security/store-tokens" target="_blank" rel="noopener">Where to Store Token</a></p></blockquote><p>无论什么时候用户想要访问受保护的路由或者资源，用户客户端必须发送 JWT，常见的是在 HTTP Autorization 的 Bearer 协议。<br>内容如下：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Authorization</span>: Bearer &lt;token&gt;</span><br></pre></td></tr></table></figure><p>这是一种无状态验证机制，用户的状态不会保存在服务器内存中。服务器可以在 HTTP Authorization 校验 JWT，通过校验则可以访问受保护的资源。正因为 JWT 是独立的，所有需要的信息都包含在其中，减少多次查询数据库。</p><p>JWTs 允许你完全依赖无状态数据 API,甚至请求下游服务。那些域为你的 API 提供服务并不重要，因此跨域资源共享（CORS）不会成为问题因为他们可以不使用 Cookie。</p><p>下面的图展示了整个过程：</p><p><img src="https://cdn.auth0.com/content/jwt/jwt-diagram.png" alt=""></p><p>对于签名令牌，需要注意所有信息都包含在令牌中并且这些信息是公开暴露的，虽然他们不能篡改它。意味着不要在令牌中存储密钥信息。</p><h2 id="为什么我们使用-JSON-Web-Tokens"><a href="#为什么我们使用-JSON-Web-Tokens" class="headerlink" title="为什么我们使用 JSON Web Tokens?"></a>为什么我们使用 JSON Web Tokens?</h2><p>让我们来谈谈 <strong>JSON Web Tokens(JWT)</strong> 的优点相对于 <strong>Simple Web Tokens(SWT)</strong> 和 <strong>Security Assertion Markup Language Tokens(SAML)</strong>。</p><p>JSON 数据比 XML 更加简洁，转码后体积依然更小，着使得 JWT 比 SAML 更加紧凑。这使得 JWT 在 HTML,HTTP 环境中传递成为了一种更好的选择。</p><p>在安全性方面，SWT 只能通过共享密钥使用 HMAC 算法进行对称加密。然而，JWT 和 SAML 令牌可以使用公/私密钥对以 X.509 格式进行签名。与 JSON 签名的简单相比，在不引入模糊安全漏洞的情况下使用 XML 数字签名来签署 XML 签名是非常难实现的。</p><p>JSON 解析器在大多数编程语言中很普及，因为它直接映射了一个对象。相反的，XML 并不含有原生的 document-to-object（文档到对象）的映射。这使得 JWT 比 SAML 更加容易运作。</p><p>至于用法，JWT 可以在互联网范围内使用，突出的是在多个客户端平台处理 JSON Web Token 的简易性，特别是移动端。</p><p><img src="https://cdn.auth0.com/content/jwt/comparing-jwt-vs-saml2.png" alt=""></p><p>如果你想了解更多 JSON Web Tokens 甚至开始在你的应用中使用它进行身份验证，在 Auth0 浏览<a href="http://auth0.com/learn/json-web-tokens" target="_blank" rel="noopener">JSON Web Token 落地页面</a></p></section><div class="tags"><span>Tags:</span> <a href="/tags#jwt"><span class="tag-code">jwt</span> </a><a href="/tags#transition"><span class="tag-code">transition</span></a></div><div class="nav-container"><a class="nav-right" href="/2018/09/06/AutoTest/">test <span class="nav-arrow">→</span></a></div><div id="disqus_thread"></div></article><aside class="catalog-container"><div class="toc-main"><strong class="toc-title">Catalog</strong><ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#什么是-JSON-Web-Token"><span class="toc-nav-text">什么是 JSON Web Token?</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#什么情况下我们应该使用-JSON-Web-Tokens？"><span class="toc-nav-text">什么情况下我们应该使用 JSON Web Tokens？</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#JSON-Web-Tokens-的结构是什么样的？"><span class="toc-nav-text">JSON Web Tokens 的结构是什么样的？</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#头部（Header）"><span class="toc-nav-text">头部（Header）</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#载荷（Payload）"><span class="toc-nav-text">载荷（Payload）</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#签名-Signature"><span class="toc-nav-text">签名(Signature)</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#放在一起"><span class="toc-nav-text">放在一起</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#JSON-Web-Tokens-是如何工作的？"><span class="toc-nav-text">JSON Web Tokens 是如何工作的？</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#为什么我们使用-JSON-Web-Tokens"><span class="toc-nav-text">为什么我们使用 JSON Web Tokens?</span></a></li></ol></div></aside></main><script>(function () {
    var url = 'whyisee.github.io/2018/07/13/json-web-token/';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

    // error image
    $(".markdown-content img").on('error', function () {
      $(this).attr('src', 'http://file.muyutech.com/error-img.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function () {
      var src = $(this).attr('src')
      if (src !== 'http://file.muyutech.com/error-img.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()

        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="' + src + '" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function () {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })

    // qrcode
    var qr = new QRious({
      element: document.getElementById('share-qrcode'),
      value: document.location.href
    });

    // gitment
    var gitmentConfig = "";
    if (gitmentConfig !== 'undefined') {
      var gitment = new Gitment({
        id: "[译] JSON Web Token Intro",
        owner: "",
        repo: "",
        oauth: {
          client_id: "",
          client_secret: ""
        },
        theme: {
          render(state, instance) {
            const container = document.createElement('div')
            container.lang = "en-US"
            container.className = 'gitment-container gitment-root-container'
            container.appendChild(instance.renderHeader(state, instance))
            container.appendChild(instance.renderEditor(state, instance))
            container.appendChild(instance.renderComments(state, instance))
            container.appendChild(instance.renderFooter(state, instance))
            return container;
          }
        }
      })
      gitment.render(document.getElementById('comments'))
    }
  })();</script><script>var disqus_shortname="zoukh",disqus_url="whyisee.github.io/2018/07/13/json-web-token/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//go.disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><div class="scroll-top"><span class="arrow-icon"></span></div></div><footer class="app-footer"><p class="copyright">&copy; 2018 | Proudly powered by <a href="https://hexo.io" target="_blank">Hexo</a><br>Theme by <a href="https://github.com/yanm1ng">yanm1ng</a></p></footer><script>function async(e,n){var t=document,a="script",r=t.createElement(a),c=t.getElementsByTagName(a)[0];r.src=e,n&&r.addEventListener("load",function(e){n(null,e)},!1),c.parentNode.insertBefore(r,c)}</script><script>async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js",function(){FastClick.attach(document.body)})</script><script>var hasLine="true";async("//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js",function(){$("figure pre").each(function(t,e){var a=$(this).parents("figure");"false"===hasLine&&a.find(".gutter").hide();var s=a.attr("class").split(" ")[1]||"code",i=$(this).html(),h=document.createElement("code");h.className=s,h.innerHTML=i,$(this).attr("class","").empty().html(h),a.attr("data-lang",s.toUpperCase()),hljs.highlightBlock(e)})})</script><script src="/js/script.js"></script></body></html>