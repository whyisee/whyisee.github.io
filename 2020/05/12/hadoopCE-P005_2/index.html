<!DOCTYPE html><html lang="zh"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><meta name="description" content="Zoukh&#39;s blog"><meta name="keyword" content="blog,front end,css,html,javascript"><link rel="shortcut icon" href="/css/images/logo.png"><title>大数据集群搭建005-P005_1zookeeper深入学习 | Zoukh&#39;s Blog</title><link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><link href="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.css" rel="stylesheet"><link href="//cdn.bootcss.com/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/style.css"><script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><script src="//cdn.bootcss.com/geopattern/1.2.3/js/geopattern.min.js"></script><script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });</script><script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script></head><div class="wechat-share"><img src="/css/images/logo.png" alt="logo"></div><body><div id="container"><header class="header fixed-header"><div class="header-container"><a class="home-link" href="/"><div class="logo"></div><span><svg height="60" width="250" id="header-svg"><symbol id="s-text"><text text-anchor="left" x="0%" y="50%" dy=".35em">Zoukh's Blog</text></symbol><use class="text" xlink:href="#s-text"></use><use class="text" xlink:href="#s-text"></use><use class="text" xlink:href="#s-text"></use><use class="text" xlink:href="#s-text"></use><use class="text" xlink:href="#s-text"></use></svg><style>#header-svg{position:absolute;top:0}@media screen and (max-width:768px){#header-svg{top:-7px}}.text{fill:none;stroke-width:2;stroke-linejoin:round;stroke-dasharray:40 185;stroke-dashoffset:0;-webkit-animation:stroke 8s infinite linear;animation:stroke 8s infinite linear;font-size:40px;line-height:1;height:40px}.text:nth-child(5n+1){stroke:#f2385a;-webkit-animation-delay:-1.6s;animation-delay:-1.6s}.text:nth-child(5n+2){stroke:#f5a503;-webkit-animation-delay:-3.2s;animation-delay:-3.2s}.text:nth-child(5n+3){stroke:#42b983;-webkit-animation-delay:-4.8s;animation-delay:-4.8s}.text:nth-child(5n+4){stroke:#56d9cd;-webkit-animation-delay:-6.4s;animation-delay:-6.4s}.text:nth-child(5n+5){stroke:#3aa1bf;-webkit-animation-delay:-8s;animation-delay:-8s}@-webkit-keyframes stroke{100%{stroke-dashoffset:-225}}@keyframes stroke{100%{stroke-dashoffset:-225}}</style></span></a><ul class="right-list"><li class="list-item"><a href="/" class="item-link">Home</a></li><li class="list-item"><a href="/tags/" class="item-link">Tags</a></li><li class="list-item"><a href="/archives/" class="item-link">Archives</a></li><li class="list-item"><a href="/project/" class="item-link">Project</a></li><li class="list-item"><a href="/about/" class="item-link">About</a></li></ul><div class="menu"><span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></div><div class="menu-mask"><ul class="menu-list"><li class="menu-item"><a href="/" class="menu-link">Home</a></li><li class="menu-item"><a href="/tags/" class="menu-link">Tags</a></li><li class="menu-item"><a href="/archives/" class="menu-link">Archives</a></li><li class="menu-item"><a href="/project/" class="menu-link">Project</a></li><li class="menu-item"><a href="/about/" class="menu-link">About</a></li></ul></div></div></header><div id="article-banner"><h2>大数据集群搭建005-P005_1zookeeper深入学习</h2><p class="post-date">2020-05-12</p></div><main class="app-body flex-box"><article class="post-article"><section class="markdown-content"><h1 id="zookeeper"><a href="#zookeeper" class="headerlink" title="zookeeper"></a>zookeeper</h1><h2 id="zookeeper是什么"><a href="#zookeeper是什么" class="headerlink" title="zookeeper是什么"></a>zookeeper是什么</h2><p>zookeeper是一个开发源码的分布式协调服务.<br>zookeeper是一个典型的分布式数据一致性解决方案,分布式应用程序可以基于它实现如数据发布/订阅,负载均衡,命名服务,分布式协调通知,集群管理,Master选举,<br>分布式锁,和分布式队列功能.</p><h2 id="zookeeper可以保证如下分布式一致性特性"><a href="#zookeeper可以保证如下分布式一致性特性" class="headerlink" title="zookeeper可以保证如下分布式一致性特性"></a>zookeeper可以保证如下分布式一致性特性</h2><h3 id="顺序一致性"><a href="#顺序一致性" class="headerlink" title="顺序一致性"></a>顺序一致性</h3><p>从同一个客户端发起的事务请求,最终会严格地按照其发起顺序被应用到zookeeper中</p><h3 id="原子性"><a href="#原子性" class="headerlink" title="原子性"></a>原子性</h3><p>所有事务请求的处理结果在整个集群上的应用情况是一致的,要么整个集群都成功,要么整个集群都不成功.</p><h3 id="单一视图"><a href="#单一视图" class="headerlink" title="单一视图"></a>单一视图</h3><p>无论客户端连接的是哪个zookeeper服务器,其看到的服务端的数据模型都是一致的.</p><h3 id="可靠性"><a href="#可靠性" class="headerlink" title="可靠性"></a>可靠性</h3><p>一旦服务端成功的应用了一个事务,并完成对客户端的响应,那么由该事务所引起的服务端状态变化将会一直保留下来,除非有另一个事务对其进行了变更.</p><h3 id="实时性"><a href="#实时性" class="headerlink" title="实时性"></a>实时性</h3><p>zookeeper保证在一定时间段内,客户端最终一定能够从服务端读取到最新的数据状态.</p><h2 id="zookeeper的设计目标"><a href="#zookeeper的设计目标" class="headerlink" title="zookeeper的设计目标"></a>zookeeper的设计目标</h2><h3 id="1-简单的数据模型"><a href="#1-简单的数据模型" class="headerlink" title="1.简单的数据模型"></a>1.简单的数据模型</h3><p>树形命名空间</p><h3 id="2-可以构建集群"><a href="#2-可以构建集群" class="headerlink" title="2.可以构建集群"></a>2.可以构建集群</h3><h3 id="3-顺序访问"><a href="#3-顺序访问" class="headerlink" title="3.顺序访问"></a>3.顺序访问</h3><p>客户端的请求会分配一个全局唯一的递增序列</p><h3 id="4-高性能"><a href="#4-高性能" class="headerlink" title="4.高性能"></a>4.高性能</h3><p>数据存储在内存中</p><h2 id="zookeeper基本概念"><a href="#zookeeper基本概念" class="headerlink" title="zookeeper基本概念"></a>zookeeper基本概念</h2><h3 id="集群角色"><a href="#集群角色" class="headerlink" title="集群角色"></a>集群角色</h3><p>zookeeper不同于一般的集群Master/Slave(主备模式),而是引用了Leader,Follower,Observer三种角色,<br>Zookeeper集群中的所有机器通过一个Leader选举过程来选定一台被称为”Leader”的集群,Leader服务器为客户端提供读和写服务,<br>除Leader外其他机器包括Follower和Observer都能提供读服务.区别在于Observer不参与选举过程,也不参与写操作的过半写成功策略.</p><h3 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h3><p>Session指客户端会话.</p><h3 id="数据节点-Znode"><a href="#数据节点-Znode" class="headerlink" title="数据节点 (Znode)"></a>数据节点 (Znode)</h3><p>Zookeeper中的节点分为两类:第一类是指常见的集群中的机器,可以称之为机器节点;第二类指数据模型中的数据单元,我们称之为数据节点-ZNode.<br>zookeeper将所有数据存储在内存中,数据模型就是一颗树,由斜杠/分割的路径就是一个Znode.每个Znode上都会保存自己的数据内容,同时还会保留一系列属性信息.<br>数据节点又分为持久节点和临时节点.</p><h3 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h3><p>zookeeper的每个Znode都会存储数据,对于每个Znode,zookeeper都会为其维护一个叫Stat的数据结构,Stat中记录了这个Znode的三个数据版本,分别是version(当前Znode版本),<br>cversion(当前Znode子节点版本)和aversion(当前Znode的ACL版本).</p><h3 id="Watcher-事件监听器"><a href="#Watcher-事件监听器" class="headerlink" title="Watcher 事件监听器"></a>Watcher 事件监听器</h3><p>Zookeeper允许用户在指定节点上注册一些Watcher,并且在一些特定事件触发的时候,zookeeper会将事件通知到感兴趣的客户端上.</p><h3 id="ACL"><a href="#ACL" class="headerlink" title="ACL"></a>ACL</h3><p>zookeeper采用ACL(Access Control Lists)策略来进行权限控制,类似unix系统的权限控制,包括:</p><ul><li>CREATE</li><li>READ</li><li>WRITER</li><li>DELETE</li><li>ADMIN</li></ul><h2 id="ZAB-Zookeeper-Atomic-Broadcast-协议-zookeeper原子消息广播协议"><a href="#ZAB-Zookeeper-Atomic-Broadcast-协议-zookeeper原子消息广播协议" class="headerlink" title="ZAB(Zookeeper Atomic Broadcast)协议,zookeeper原子消息广播协议"></a>ZAB(Zookeeper Atomic Broadcast)协议,zookeeper原子消息广播协议</h2><p>所有事务的请求必须由一个全局唯一的服务器来协调处理,这样的服务器被称为Leader服务器,<br>而余下的其他服务器则称为follower服务器.Leader服务器负责将一个客户端请求装换成一个事务Proposal(提取),<br>并将该proposal分发给集群中的其他所有follower服务器.之后leader服务器需要等待所有的folloer服务器反馈,<br>一旦超过半数的follower服务器进行了正确的反馈后那么Leader就会再次向所有的follower服务器分发commit消息,要求其将前一个proposal进行提交.</p><p>ZAB主要有三个阶段:</p><ul><li>发现</li><li>同步</li><li>广播</li></ul><h2 id="zookeeper使用"><a href="#zookeeper使用" class="headerlink" title="zookeeper使用"></a>zookeeper使用</h2><p>使用起来还是比较简单的配置文件可以只改一个zoo.cfg</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#重要配置</span><br><span class="line">tickTime=2000</span><br><span class="line">initLimit=10</span><br><span class="line">syncLimit=5</span><br><span class="line">clientPort=2181</span><br><span class="line">dataDir=/data01/zookeeper</span><br><span class="line">server.1=hadoop01:2888:3888</span><br><span class="line">server.2=hadoop02:2888:3888</span><br><span class="line">server.3=hadoop03:2888:3888</span><br></pre></td></tr></table></figure><p>启动时候需要在机器的dataDir下创建一个myid文件,文件内容就是对应的sercer的id</p><h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><ul><li>stat 测试指令不存在</li></ul><p>在zkServer.sh中加上</p><blockquote><p>ZOOMAIN=”-Dzookeeper.4lw.commands.whitelist=* ${ZOOMAIN}”</p></blockquote><ul><li>磁盘空间不足</li><li>无法找到myid文件</li><li>集群其他机器leader选举端口未打开</li></ul><h2 id="客户端脚本"><a href="#客户端脚本" class="headerlink" title="客户端脚本"></a>客户端脚本</h2><p><strong>连接</strong></p><p>默认连接localhost:2181</p><blockquote><p>sh zkCli.sh</p></blockquote><blockquote><p>sh zkCli.sh -server ip:port</p></blockquote><p><strong>创建节点</strong></p><blockquote><p>create [-s] [-e] path data acl</p></blockquote><p>-s指定顺序节点<br>-e指定临时节点</p><p><strong>读取</strong></p><p>列出所有子节点</p><blockquote><p>ls</p></blockquote><p>获取指定节点数据内容</p><blockquote><p>get</p></blockquote><p><strong>更新</strong></p><blockquote><p>set path data [version]</p></blockquote><p><strong>删除</strong></p><blockquote><p>delete path [version]</p></blockquote><h2 id="java客户端API"><a href="#java客户端API" class="headerlink" title="java客户端API"></a>java客户端API</h2><h2 id="开源客户端ZkClient"><a href="#开源客户端ZkClient" class="headerlink" title="开源客户端ZkClient"></a>开源客户端ZkClient</h2></section><div class="tags"><span>Tags:</span> <a href="/tags#hadoop,zookeeper"><span class="tag-code">hadoop,zookeeper</span></a></div><div class="nav-container"><a class="nav-left" href="/2020/05/12/hadoopCE-P005_3/"><span class="nav-arrow">← </span>大数据集群搭建005_3-zookeeper应用篇</a></div><div id="disqus_thread"></div></article><aside class="catalog-container"><div class="toc-main"><strong class="toc-title">Catalog</strong><ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#zookeeper"><span class="toc-nav-text">zookeeper</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#zookeeper是什么"><span class="toc-nav-text">zookeeper是什么</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#zookeeper可以保证如下分布式一致性特性"><span class="toc-nav-text">zookeeper可以保证如下分布式一致性特性</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#顺序一致性"><span class="toc-nav-text">顺序一致性</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#原子性"><span class="toc-nav-text">原子性</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#单一视图"><span class="toc-nav-text">单一视图</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#可靠性"><span class="toc-nav-text">可靠性</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#实时性"><span class="toc-nav-text">实时性</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#zookeeper的设计目标"><span class="toc-nav-text">zookeeper的设计目标</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#1-简单的数据模型"><span class="toc-nav-text">1.简单的数据模型</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#2-可以构建集群"><span class="toc-nav-text">2.可以构建集群</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#3-顺序访问"><span class="toc-nav-text">3.顺序访问</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#4-高性能"><span class="toc-nav-text">4.高性能</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#zookeeper基本概念"><span class="toc-nav-text">zookeeper基本概念</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#集群角色"><span class="toc-nav-text">集群角色</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#会话"><span class="toc-nav-text">会话</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#数据节点-Znode"><span class="toc-nav-text">数据节点 (Znode)</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#版本"><span class="toc-nav-text">版本</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Watcher-事件监听器"><span class="toc-nav-text">Watcher 事件监听器</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#ACL"><span class="toc-nav-text">ACL</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#ZAB-Zookeeper-Atomic-Broadcast-协议-zookeeper原子消息广播协议"><span class="toc-nav-text">ZAB(Zookeeper Atomic Broadcast)协议,zookeeper原子消息广播协议</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#zookeeper使用"><span class="toc-nav-text">zookeeper使用</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#常见问题"><span class="toc-nav-text">常见问题</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#客户端脚本"><span class="toc-nav-text">客户端脚本</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#java客户端API"><span class="toc-nav-text">java客户端API</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#开源客户端ZkClient"><span class="toc-nav-text">开源客户端ZkClient</span></a></li></ol></li></ol></div></aside></main><script>(function () {
    var url = 'https://whyisee.github.io/2020/05/12/hadoopCE-P005_2/';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

    // error image
    $(".markdown-content img").on('error', function () {
      $(this).attr('src', 'http://file.muyutech.com/error-img.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function () {
      var src = $(this).attr('src')
      if (src !== 'http://file.muyutech.com/error-img.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()

        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="' + src + '" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function () {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })

    // qrcode
    var qr = new QRious({
      element: document.getElementById('share-qrcode'),
      value: document.location.href
    });

    // gitment
    var gitmentConfig = "";
    if (gitmentConfig !== 'undefined') {
      var gitment = new Gitment({
        id: "大数据集群搭建005-P005_1zookeeper深入学习",
        owner: "",
        repo: "",
        oauth: {
          client_id: "",
          client_secret: ""
        },
        theme: {
          render(state, instance) {
            const container = document.createElement('div')
            container.lang = "en-US"
            container.className = 'gitment-container gitment-root-container'
            container.appendChild(instance.renderHeader(state, instance))
            container.appendChild(instance.renderEditor(state, instance))
            container.appendChild(instance.renderComments(state, instance))
            container.appendChild(instance.renderFooter(state, instance))
            return container;
          }
        }
      })
      gitment.render(document.getElementById('comments'))
    }
  })();</script><script>var disqus_shortname="zoukh",disqus_url="https://whyisee.github.io/2020/05/12/hadoopCE-P005_2/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//go.disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><div class="scroll-top"><span class="arrow-icon"></span></div></div><footer class="app-footer"><p class="copyright">&copy; 2020 | Proudly powered by <a href="https://hexo.io" target="_blank">Hexo</a><br>Theme by <a href="https://github.com/yanm1ng">yanm1ng</a></p></footer><script>function async(e,n){var t=document,a="script",r=t.createElement(a),c=t.getElementsByTagName(a)[0];r.src=e,n&&r.addEventListener("load",function(e){n(null,e)},!1),c.parentNode.insertBefore(r,c)}</script><script>async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js",function(){FastClick.attach(document.body)})</script><script>var hasLine="true";async("//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js",function(){$("figure pre").each(function(t,e){var a=$(this).parents("figure");"false"===hasLine&&a.find(".gutter").hide();var s=a.attr("class").split(" ")[1]||"code",i=$(this).html(),h=document.createElement("code");h.className=s,h.innerHTML=i,$(this).attr("class","").empty().html(h),a.attr("data-lang",s.toUpperCase()),hljs.highlightBlock(e)})})</script><script>var _baId="38d9d6cd6dd01ce7d270b91920f6a51b",_hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?"+_baId;var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script src="/js/script.js"></script></body></html>